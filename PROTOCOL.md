# PCAP 文件格式协议说明

## 目录

1. [版本历史](#版本历史)
2. [概述](#概述)
3. [文件格式](#文件格式)
   - [PCAP 工程文件格式](#pcap-工程文件格式)
   - [PATA 数据文件格式](#pata-数据文件格式)
4. [数据规范](#数据规范)
   - [时间同步要求](#时间同步要求)
   - [数据格式要求](#数据格式要求)
   - [数据压缩规范](#数据压缩规范)
5. [应用场景](#应用场景)
   - [数据采集](#数据采集)
   - [数据回放](#数据回放)
6. [工具支持](#工具支持)
   - [基础工具集](#基础工具集)
   - [开发支持](#开发支持)
   - [工程文件工具](#工程文件工具)
7. [安全性考虑](#安全性考虑)
   - [数据完整性](#数据完整性)

## 版本历史

| 版本号 | 日期       | 变更说明                                                                     |
| ------ | ---------- | ---------------------------------------------------------------------------- |
| 0.0.1  | 2024-12-26 | 初始版本                                                                     |
| 0.0.2  | 2024-03-19 | 简化数据格式，移除 PacketDataHeader 层，允许用户直接存储任意字节数组         |
| 0.0.3  | 2024-03-20 | 补充工程文件机制详细说明，包括索引间隔作用、时间范围索引重要性和索引生成方式 |

## 概述

本文档定义了一种基于 PCAP（Packet Capture）格式的数据存储标准，用于存储和回放各类仿真应用与实装应用的采集数据。该格式在保留 PCAP 文件格式核心优势的基础上，针对高性能数据采集、实时回放和分析场景进行了专门的优化与扩展。

### 主要特点

- 支持多源异构数据的统一存储：通过统一的封装格式和标准化的接口，实现对不同来源、不同类型数据的一致性管理
- 提供精确的时间戳和同步机制：支持毫秒级的时间精度，确保多源数据的时序一致性
- 支持数据压缩和加密：提供可选的压缩算法和加密机制，平衡存储效率和安全性需求
- 提供高效的工程文件管理：实现了多级索引结构，支持快速的时间定位和数据检索

### 适用场景

- 仿真系统数据采集与回放：适用于复杂系统仿真过程中的数据记录和重现
- 实时系统行为记录与重现：支持对实时系统运行状态的完整记录和精确重现
- 分布式应用的数据同步：为分布式系统提供统一的数据同步和管理机制
- 系统调试与性能分析：提供详细的系统行为记录，便于问题定位和性能优化

### 设计考虑

1. 性能优化

   - 采用高效的数据组织结构，最小化存取开销
   - 支持并行处理和异步 IO，提高数据处理效率
   - 实现智能缓存机制，优化频繁访问场景

2. 可靠性保证

   - 多重校验机制确保数据完整性
   - 完善的错误处理和恢复机制
   - 支持断点续传和数据恢复

3. 兼容性考虑
   - 保持与标准 PCAP 格式的兼容性
   - 支持跨平台数据交换
   - 提供版本升级路径

## 文件格式

本协议定义了两种文件格式：PCAP 工程文件和 PATA 数据文件。PCAP 工程文件用于管理数据文件的索引和元数据，而 PATA 数据文件用于存储实际的数据包内容。

### PCAP 工程文件格式

工程文件采用标准 PCAP 格式，用于管理数据文件的索引和元数据。文件结构如下：

```
工程文件 (project.pcap)
+------------------------------------------+
| 文件头部 (32字节)                         |
| - Magic Number (4字节): 0xA1B2C3D4       |
| - Major Version (2字节): 1               |
| - Minor Version (2字节): 0               |
| - File Entry Offset (4字节): 32          |
| - File Count (2字节): 3                  |
| - Time Index Offset (4字节): 32+3*50     |
| - Index Interval (2字节): 1000           |
| - Total Index Count (4字节): 10800       |
| - Checksum (4字节): CRC32值              |
| - Reserved (2字节): 0                    |
+------------------------------------------+
| 文件条目表 (3个条目，每个50字节)         |
| 条目1:                                   |
| - File ID (4字节): 1                     |
| - Path Length (2字节): 20                |
| - Relative Path (20字节):                |
|   "Packet_Data/data_001.pata"            |
| - Start Timestamp (8字节):               |
|   2024-03-20 11:00:00.000000             |
| - End Timestamp (8字节):                 |
|   2024-03-20 12:00:00.000000             |
| - Index Count (4字节): 3600              |
| - Reserved (4字节): 0                    |
|                                          |
| 条目2:                                   |
| - File ID (4字节): 2                     |
| - Path Length (2字节): 20                |
| - Relative Path (20字节):                |
|   "Packet_Data/data_002.pata"            |
| - Start Timestamp (8字节):               |
|   2024-03-20 12:00:00.000000             |
| - End Timestamp (8字节):                 |
|   2024-03-20 13:00:00.000000             |
| - Index Count (4字节): 3600              |
| - Reserved (4字节): 0                    |
|                                          |
| 条目3:                                   |
| - File ID (4字节): 3                     |
| - Path Length (2字节): 20                |
| - Relative Path (20字节):                |
|   "Packet_Data/data_003.pata"            |
| - Start Timestamp (8字节):               |
|   2024-03-20 13:00:00.000000             |
| - End Timestamp (8字节):                 |
|   2024-03-20 14:00:00.000000             |
| - Index Count (4字节): 3600              |
| - Reserved (4字节): 0                    |
+------------------------------------------+
| 时间范围索引表 (10800个条目，每个12字节) |
| 条目1:                                   |
| - Timestamp (8字节):                     |
|   2024-03-20 11:00:00.000000             |
| - File ID (4字节): 1                     |
|                                          |
| 条目2:                                   |
| - Timestamp (8字节):                     |
|   2024-03-20 11:00:01.000000             |
| - File ID (4字节): 1                     |
| ...                                      |
+------------------------------------------+
| 文件1的索引表 (3600个条目，每个16字节)   |
| 条目1:                                   |
| - Timestamp (8字节):                     |
|   2024-03-20 11:00:00.000000             |
| - File Offset (8字节): 16                |
|                                          |
| 条目2:                                   |
| - Timestamp (8字节):                     |
|   2024-03-20 11:00:01.000000             |
| - File Offset (8字节): 100               |
| ...                                      |
+------------------------------------------+
| 文件2的索引表 (3600个条目，每个16字节)   |
| 条目1:                                   |
| - Timestamp (8字节):                     |
|   2024-03-20 12:00:00.000000             |
| - File Offset (8字节): 16                |
| ...                                      |
+------------------------------------------+
| 文件3的索引表 (3600个条目，每个16字节)   |
| 条目1:                                   |
| - Timestamp (8字节):                     |
|   2024-03-20 13:00:00.000000             |
| - File Offset (8字节): 16                |
| ...                                      |
+------------------------------------------+

文件大小计算：
1. 文件头部：32字节
2. 文件条目表：3 * 50 = 150字节
3. 时间范围索引表：10800 * 12 = 129600字节
4. 文件索引表：3 * 3600 * 16 = 172800字节

总大小：302582字节 ≈ 295.5KB
```

#### 文件头部（32 字节）

| 偏移量 | 长度(字节) | 名称              | 描述                             |
| ------ | ---------- | ----------------- | -------------------------------- |
| 0      | 4          | Magic Number      | 固定值 0xA1B2C3D4                |
| 4      | 2          | Major Version     | 主版本号                         |
| 6      | 2          | Minor Version     | 次版本号                         |
| 8      | 4          | File Entry Offset | 文件条目表偏移量                 |
| 12     | 2          | File Count        | 数据文件数量，写入数据时更新     |
| 14     | 4          | Time Index Offset | 时间索引表偏移量，写入数据时更新 |
| 18     | 2          | Index Interval    | 索引间隔(毫秒)                   |
| 20     | 4          | Total Index Count | 总索引项数，写入数据时更新       |
| 24     | 4          | Checksum          | CRC32 值，写入数据时更新         |
| 28     | 2          | Reserved          | 保留字段                         |

**索引间隔说明**：

- 索引间隔参数用于控制索引的采样密度，而非要求数据必须按固定间隔写入
- 系统会在构建索引时，按照指定的时间间隔（如 1000 毫秒）选取采样点
- 对于每个采样时间点，系统会找到该时间点之后的第一个数据包，并为其创建索引项
- 如果某个时间区间内没有数据，则不会创建该时间点的索引项
- 通过调整索引间隔参数，可以在检索性能和工程文件大小之间找到平衡点
- 较小的索引间隔提供更精确的定位能力，但会增加工程文件大小
- 较大的索引间隔可减少工程文件大小，但可能增加定位时的线性搜索范围

#### 文件条目表

| 偏移量 | 长度(字节) | 名称            | 描述              |
| ------ | ---------- | --------------- | ----------------- |
| 0      | 4          | File ID         | 文件标识符        |
| 4      | 2          | Path Length     | 相对路径长度      |
| 6      | 256        | Relative Path   | 相对路径（UTF-8） |
| 262    | 8          | Start Timestamp | 起始时间戳(毫秒)  |
| 270    | 8          | End Timestamp   | 结束时间戳(毫秒)  |
| 278    | 4          | Index Count     | 文件内索引项数量  |
| 282    | 4          | Reserved        | 保留字段          |

**文件条目表说明**：

- 文件条目表采用固定长度记录格式，每个条目 286 字节
- 相对路径字段使用 UTF-8 编码，支持多语言文件名
- 文件 ID 用于唯一标识文件，在时间范围索引表中引用
- 路径长度字段用于定位后续字段的偏移量
- 所有时间戳采用 UTC 时间，精确到毫秒
- 文件大小可通过文件系统直接获取，无需在索引中存储
- 文件内索引表偏移量可通过前面文件的索引项数量计算得到（每个索引项 16 字节）

#### 时间范围索引表

| 偏移量 | 长度(字节) | 名称      | 描述         |
| ------ | ---------- | --------- | ------------ |
| 0      | 4          | File ID   | 文件标识符   |
| 4      | 8          | Timestamp | 时间戳(毫秒) |

**时间范围索引表说明**：

- 时间范围索引是多文件场景下的核心检索机制，用于快速定位特定时间点的数据所在的文件
- 作用原理：记录采样时间点与包含该时间点数据的文件 ID 之间的映射关系
- 主要优势：
  - 避免在多文件环境下打开每个文件查找特定时间点的数据
  - 实现跨文件的高效时间检索，大幅降低检索延迟
  - 支持大规模数据集的高效管理和访问
- 检索流程：
  - 首先在时间范围索引表中通过二分查找确定目标时间所在的文件
  - 然后使用文件 ID 找到相应的文件条目信息
  - 最后在目标文件的文件内索引中精确定位数据包位置
- 构建策略：
  - 每个索引间隔点对应时间范围索引表中的一个条目
  - 当单个索引区间跨越多个文件时，确保每个文件的起始数据包都有对应的索引项
  - 对于时间不连续的数据文件集合，保证时间边界处有完整的索引覆盖

#### 文件内索引表

| 偏移量 | 长度(字节) | 名称        | 描述                   |
| ------ | ---------- | ----------- | ---------------------- |
| 0      | 8          | Timestamp   | 时间戳(毫秒)           |
| 8      | 8          | File Offset | 数据包在文件中的偏移量 |

**文件内索引表说明**：

- 文件内索引表是连续存储在工程文件中的，每个文件的索引表按顺序排列
- 索引表偏移量用于快速定位每个文件的索引表在工程文件中的具体位置
- 由于每个索引项大小固定（16 字节），索引表偏移量可以通过计算得到：
  ```csharp
  // 计算文件N的索引表偏移量
  long offset = 文件头部大小 + 文件条目表大小 + 时间范围索引表大小 +
                (文件1的IndexCount + 文件2的IndexCount + ... + 文件N-1的IndexCount) * 16
  ```
- 这种设计允许系统快速访问任意文件的索引表，无需遍历前面的文件
- 索引表偏移量在文件条目表中存储，便于系统快速定位和访问

### PATA 数据文件格式

PATA 数据文件采用简单清晰的结构设计，文件由文件头和多个数据包组成，每个数据包包含包头和数据内容两部分。文件结构如下：

```
PATA 数据文件 (data_001.pata)
+------------------------------------------+
| 文件头部 (16字节)                         |
| - Magic Number (4字节): 0x50415441       |
| - Major Version (2字节): 1               |
| - Minor Version (2字节): 0               |
| - Timezone (4字节): 0                    |
| - Timestamp Accuracy (4字节): 1000       |
+------------------------------------------+
| 数据包1 (变长)                           |
| - 包头 (16字节)                          |
|   * Timestamp (8字节):                   |
|     2024-03-20 11:00:00.000             |
|   * Packet Length (4字节): 100           |
|   * Checksum (4字节): CRC32值            |
| - 数据内容 (100字节)                     |
|   * 任意格式的字节数组                   |
+------------------------------------------+
| 数据包2 (变长)                           |
| - 包头 (16字节)                          |
|   * Timestamp (8字节):                   |
|     2024-03-20 11:00:01.000             |
|   * Packet Length (4字节): 150           |
|   * Checksum (4字节): CRC32值            |
| - 数据内容 (150字节)                     |
|   * 任意格式的字节数组                   |
+------------------------------------------+
| ... 更多数据包 ...                       |
+------------------------------------------+

文件大小计算：
1. 文件头部：16字节
2. 数据包1：16 + 100 = 116字节
3. 数据包2：16 + 150 = 166字节
4. ... 更多数据包 ...

总大小：16 + Σ(16 + PacketLength)
```

#### 文件头格式 (PATA File Header)

文件头用于标识文件格式和版本信息，同时提供基本的时间同步参数。文件头采用固定长度设计，确保解析效率。

文件头总长度：16 字节

| 偏移量 | 长度(字节) | 名称               | 描述                                             |
| ------ | ---------- | ------------------ | ------------------------------------------------ |
| 0      | 4          | Magic Number       | 标识文件格式的魔术数，固定值 0x50415441 ("PATA") |
| 4      | 2          | Major Version      | 主版本号 (当前为 1)                              |
| 6      | 2          | Minor Version      | 次版本号 (当前为 0)                              |
| 8      | 4          | Timezone           | 时区偏移量 (GMT)                                 |
| 12     | 4          | Timestamp Accuracy | 时间戳精度 (毫秒)                                |

**文件头说明**：

- Magic Number 用于快速识别文件格式
- 版本号支持协议升级和向后兼容
- 时区偏移量用于时间戳的本地化处理
- 时间戳精度定义了时间戳的最小单位

#### 数据包头格式 (Packet Header)

数据包头为每个数据包提供时间戳和长度信息，同时引入校验机制确保数据完整性。

每个数据包前的包头长度：16 字节

| 偏移量 | 长度(字节) | 名称          | 描述                           |
| ------ | ---------- | ------------- | ------------------------------ |
| 0      | 8          | Timestamp     | 数据包捕获时间戳（毫秒）       |
| 8      | 4          | Packet Length | 数据包长度                     |
| 12     | 4          | Checksum      | 数据包校验和（包含包头和数据） |

**数据包头说明**：

- 时间戳采用 UTC 时间，精确到毫秒
- 数据包长度字段用于快速定位下一个数据包
- 校验和采用 CRC32 算法，确保数据完整性
- 包头采用固定长度设计，便于解析和定位

#### 数据包内容 (Packet Data)

数据包内容部分采用灵活的设计，允许存储任意格式的字节数组。这种设计具有以下优势：

1. 格式灵活性

   - 支持任意类型的数据格式
   - 无需额外的格式转换
   - 便于集成现有系统

2. 性能优化

   - 直接存储原始数据
   - 减少数据转换开销
   - 支持高效的数据传输

3. 应用场景

   - 日志数据：JSON、XML、文本等
   - 二进制数据：图像、音频、视频等
   - 结构化数据：协议消息、配置信息等
   - 自定义格式：特定应用的数据格式

4. 数据组织建议
   - 建议在数据包内容中包含数据类型标识
   - 可以使用标准序列化格式（如 Protocol Buffers）
   - 支持数据压缩和加密
   - 提供数据版本控制机制

## 数据规范

数据规范是确保系统数据一致性和可靠性的基础。本章节详细规定了时间同步和数据格式等关键规范要求。所有接入系统的数据必须严格遵循这些规范,以保证数据的互操作性和可用性。

### 时间同步要求

为确保系统范围内的时间一致性,时间同步机制需要满足以下具体要求:

1.  时间基准：
    - 采用 UTC 时间作为统一基准
    - 支持 GPS/北斗等外部时间源
2.  时间戳格式：
    - 分辨率：毫秒级精度
    - 格式：64 位整数，单位为毫秒
    - 基准时间：UTC 时间

### 数据格式要求

1.  数值类型：
    - 整型：支持 8/16/32/64 位
    - 浮点：支持单精度和双精度
    - 定点：支持 Q 格式定点数

数值类型的具体要求如下:

1.  整型数据
    - 有符号整型采用补码表示
    - 跨平台传输时统一采用网络字节序
    - 明确定义溢出处理策略
    - 提供数值范围检查机制
2.  浮点数据
    - 严格遵循 IEEE754 标准
    - 明确定义 NaN 和 Infinity 的处理方式
    - 提供精度损失检测机制
    - 实现浮点数比较容差处理
3.  定点数据
    - 明确定义小数位数和比例因子
    - 提供定点数运算库
    - 实现溢出保护机制
    - 支持定点数格式转换
4.  数据对齐：
    - 结构体成员按自然边界对齐
    - 填充字节使用 0x00
    - 保证跨平台数据一致性

数据对齐规范的详细要求:

1.  结构体对齐
    - 1 字节数据类型：任意地址
    - 2 字节数据类型：2 字节边界对齐
    - 4 字节数据类型：4 字节边界对齐
    - 8 字节数据类型：8 字节边界对齐
2.  打包规则
    - 提供强制 1 字节对齐选项
    - 明确定义跨平台打包规则
    - 支持结构体版本控制
    - 实现向前和向后兼容

## 应用场景

### 数据采集

数据采集是本协议的核心应用场景之一，需要保证数据的完整性和实时性。

1.  实时采集：
    - 支持高速数据流采集
    - 缓冲机制避免数据丢失
    - 支持多源数据并行采集
2.  离线采集：
    - 支持批量数据导入
    - 数据有效性验证
    - 支持断点续传

### 数据回放

数据回放是本协议的重要应用场景，需要支持灵活的回放控制和精确的时序还原。

1.  回放模式：
    - 实时回放：按原始时间间隔回放
    - 变速回放：支持倍速调节（0.1x-100x）
    - 步进回放：单步触发模式
    - 循环回放：支持区间重复播放

回放控制精度：

- 时间精度：毫秒级
- 速率误差：≤0.1%
- 抖动控制：≤1ms

1.  回放控制：
    - 支持暂停/继续
    - 支持跳转至指定时间点
    - 支持数据循环回放
    - 支持回放范围设置
    - 支持关键点标记和快速定位
2.  回放同步：
    - 多源数据同步回放
    - 外部时钟同步支持
    - 硬件触发接口
    - 网络同步机制

## 工具支持

### 基础工具集

1.  数据采集工具
2.  回放控制器
3.  数据格式转换器
4.  完整性检查工具

### 开发支持

1.  SDK 支持：
    - C++库
    - Python 接口
    - 其他语言绑定
2.  示例代码：
    - 数据读写示例
    - 回放控制示例
    - 格式转换示例

### 工程文件工具

1.  工程文件构建工具：
    - 支持实时构建和更新工程文件
    - 提供多文件工程文件合并功能
    - 支持工程文件完整性验证
    - 支持损坏工程文件的重建
2.  工程文件优化工具：
    - 工程文件压缩和重组
    - 冗余索引清理
    - 工程文件性能分析

#### 工程文件生成方式

本协议支持两种工程文件生成方式，分别适用于不同的应用场景：

1.  **实时工程文件生成**：

    - 在数据包写入过程中自动构建工程文件
    - 数据写入器维护索引缓冲区，定期刷新到临时工程文件
    - 文件写入完成时生成最终工程文件
    - 优势：
      - 工程文件与数据同步创建，确保数据可立即被高效检索
      - 避免后期批量建工程文件的性能开销
      - 数据存储结束后可立即使用完整功能
    - 实现机制：
      - 按照设定的索引间隔保存关键数据包的时间戳和偏移量
      - 支持增量索引添加，避免内存占用过大
      - 提供工程文件完整性校验

2.  **后期工程文件重建**：
    - 独立于数据写入过程，可在数据采集完成后执行
    - 支持扫描指定目录，自动识别并处理所有数据文件
    - 可用于修复损坏的工程文件或优化现有工程文件
    - 优势：
      - 支持处理已有数据文件，无需重新采集
      - 可修改索引参数（如索引间隔）以优化性能
      - 支持批量处理大量历史数据
      - 可执行多线程并行处理加速工程文件构建
    - 实现机制：
      - 多线程文件扫描和解析
      - 智能识别文件时间范围并排序
      - 自动合并多个文件的索引
      - 提供进度报告和错误恢复能力

两种工程文件生成方式可以同时在系统中提供，实现最大的灵活性。在应用中可根据实际需求选择合适的工程文件生成策略，或组合使用以满足复杂场景需求。

## 安全性考虑

### 数据完整性

数据完整性是确保数据可靠性的基础。本协议采用 CRC32 校验机制来保证数据包的完整性：

1. 校验范围：

   - 数据包头（16 字节）
   - 数据包内容（变长）

2. 校验计算：

   - 采用标准 CRC32 算法
   - 校验值存储在包头中
   - 读取时自动验证

3. 错误处理：
   - 校验失败时抛出异常
   - 支持跳过损坏的数据包
   - 提供错误日志记录
