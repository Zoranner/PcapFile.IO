# PcapFile.IO.UdpTransmitter

PCAP文件UDP网络传输工具，支持传输、组播、单播三种网络模式，用于将PCAP文件中的数据包通过UDP网络进行传输。

## 功能特性

- **多种网络模式**: 支持传输、组播、单播三种传输模式
- **PCAP数据集支持**: 基于PcapFile.IO核心库，支持数据集目录模式
- **多文件处理**: 支持批量处理数据集目录中的多个PCAP文件
- **播放速度控制**: 可调节数据包发送的时间间隔，支持快速或慢速播放
- **实时统计**: 显示传输进度、速率、错误统计等信息
- **校验和验证**: 自动验证数据包校验和的正确性
- **多线程处理**: 使用生产者-消费者模式，提高处理效率
- **智能模式识别**: 根据IP地址自动识别网络传输模式

## 使用方法

### 基本用法

```bash
PcapFileUdpTransmitter <基础目录> <数据集名称> [选项]
```

### 目录结构要求

程序要求按照以下目录结构组织PCAP文件: 

```
基础目录/
  └── 数据集名称/
      ├── file1.pcap
      ├── file2.pcap
      └── ...
```

### 命令行选项

- `-a, --address <IP地址>`: 指定目标IP地址
  - 传输: 255.255.255.255 (默认)
  - 组播: 224.0.0.0-239.255.255.255
  - 单播: 其他有效IP地址
- `-p, --port <端口>`: 指定目标端口 (默认: 12345)
- `-m, --mode <模式>`: 指定网络模式
  - `Broadcast` - 传输模式
  - `Multicast` - 组播模式  
  - `Unicast` - 单播模式
  - (如未指定，根据IP地址自动判断)
- `-s, --speed <倍速>`: 指定播放速度 (默认: 1)
- `-b, --buffer <大小>`: 指定缓冲区大小 (默认: 1000)
- `--quiet`: 关闭详细输出模式

### 使用示例

#### 传输模式
```bash
PcapFileUdpTransmitter C:\Data MyProject -a 255.255.255.255 -p 12345
```

#### 组播模式
```bash
PcapFileUdpTransmitter /data MyProject -a 239.255.255.250 -p 12345
```

#### 单播模式
```bash
PcapFileUdpTransmitter ./data MyProject -a 192.168.1.100 -p 12345
```

#### 自动模式识别
```bash
# 系统会根据IP地址自动选择合适的网络模式
PcapFileUdpTransmitter ./data TestProject -a 224.1.1.1 -p 9999
```

## 网络模式详解

### 传输模式 (Broadcast)
- **特点**: 发送到网络中的所有设备
- **IP地址**: 使用传输地址，如 255.255.255.255
- **应用场景**: 局域网内的设备发现、批量数据分发

### 组播模式 (Multicast)  
- **特点**: 发送到特定组播组的设备
- **IP地址**: IPv4 组播地址 (224.0.0.0-239.255.255.255) 或 IPv6 组播地址 (ff00::/8)
- **应用场景**: 流媒体传输、多点数据同步

### 单播模式 (Unicast)
- **特点**: 发送到指定的单个设备
- **IP地址**: 普通的单播IP地址
- **应用场景**: 点对点数据传输、精确目标投递

## 架构设计

### 核心组件

1. **PcapReader**: 使用PcapFile.IO核心库的读取器，支持数据集目录模式
2. **UdpTransmitter**: UDP网络传输器，支持三种网络模式
3. **BroadcastCoordinator**: 传输协调器，协调读取和发送线程
4. **Statistics**: 统计信息收集器，实时收集传输数据
5. **NetworkMode**: 网络模式枚举，定义传输模式

### 工作流程

1. **数据集验证**: 验证基础目录和数据集目录的存在
2. **文件扫描**: 扫描数据集目录中的所有PCAP文件
3. **网络配置**: 根据指定模式配置UDP客户端
4. **数据读取**: 使用核心库读取PCAP数据包
5. **网络传输**: 通过指定模式发送数据包
6. **进度监控**: 实时显示传输统计信息

## 技术特性

### 性能优化

- **异步I/O**: 使用异步文件读取，提高I/O效率
- **多线程**: 读取和发送线程分离，避免阻塞
- **缓冲队列**: 使用线程安全的阻塞队列，平衡处理速度
- **批量处理**: 批量读取数据包，减少系统调用开销

### 网络适配

- **多模式支持**: 自动配置不同网络模式的UDP选项
- **IPv6支持**: 完整支持IPv6网络环境
- **大包分片**: 自动处理超过UDP最大传输单元的数据包
- **网络拥塞控制**: 智能延迟控制，避免网络拥塞

### 错误处理

- **校验和验证**: 自动验证每个数据包的CRC32校验和
- **异常恢复**: 遇到问题时继续处理后续数据
- **详细日志**: 提供完整的错误信息和处理统计

## 统计信息

程序运行时显示的统计信息: 

- **传输进度**: 已传输的数据包数量和字节数  
- **传输速率**: 每秒处理的数据包数量
- **队列状态**: 当前缓冲队列的大小
- **校验错误**: 校验和验证失败的数据包数量
- **包大小统计**: 最小、最大和平均数据包大小
- **运行时间**: 总的传输时间和平均速率

## 注意事项

1. **目录结构**: 必须按照数据集目录的结构组织PCAP文件
2. **网络权限**: 传输和组播功能可能需要管理员权限
3. **防火墙设置**: 确保目标端口未被防火墙阻挡
4. **网络带宽**: 大量数据传输时注意网络带宽限制
5. **组播配置**: 使用组播时确保网络设备支持组播路由
6. **内存使用**: 大文件处理时注意内存使用情况

## 依赖项

- .NET 8.0 或更高版本
- PcapFile.IO 核心库
- System.Net.Sockets

## 编译和运行

```bash
# 编译项目
dotnet build

# 运行程序
dotnet run -- <基础目录> <数据集名称> [选项]

# 发布可执行文件
dotnet publish -c Release -r win-x64 --self-contained
``` 